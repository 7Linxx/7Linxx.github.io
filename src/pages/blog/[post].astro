---
import DefaultLayout from '@layouts/DefaultLayout.astro'
import PageHeader from '@components/PageHeader.astro'
import { BLOG_API_URL } from 'astro:env/server'
import { slugify } from '@utils/slugify'

interface ApiPost {
  id: number
  userId: number
  title: string
  body: string
}

interface Props {
  post: ApiPost & {
    featuredImage: string
  }
}

export async function getStaticPaths() {
  if (!BLOG_API_URL) {
    console.warn('BLOG_API_URL not set; skipping blog generation.')
    return []
  }
  let data: ApiPost[] = []
  try {
    const response = await fetch(BLOG_API_URL)
    if (!response.ok) {
      console.warn(`BLOG_API_URL returned ${response.status}`)
      return []
    }
    data = (await response.json()) as ApiPost[]
  } catch (error) {
    console.warn('Failed to fetch blog posts', error)
    return []
  }

  const postImages = [
    { src: '/posts/post-image-1.png' },
    { src: '/posts/post-image-2.png' },
    { src: '/posts/post-image-3.png' },
    { src: '/posts/post-image-4.png' },
    { src: '/posts/post-image-5.png' },
    { src: '/posts/post-image-6.png' },
  ]

  function truncateTitle(title: string) {
    const words = title.split(' ')
    const truncated = words.slice(0, 4).join(' ')
    return {
      full: title,
      truncated: truncated,
    }
  }

  return data.map((post) => {
    const titleObj = truncateTitle(post.title)

    const postWithImage = {
      ...post,
      featuredImage: postImages[post.id % postImages.length].src,
      title: titleObj.truncated,
    }

    return {
      params: { post: slugify(titleObj.truncated) },
      props: { post: postWithImage },
    }
  })
}

const { post } = Astro.props as Props
const postSlug = Astro.params.post ?? slugify(post.title)
const canonicalUrl = new URL(`/blog/${postSlug}`, Astro.site ?? Astro.url).href
const author = {
  name: 'Luna Calderón',
  image: '/posts/post-image-1.png',
  bio: 'Estudiante de Ingeniería de Sistemas',
}
---

<DefaultLayout title={post.title} description={post.body} url={canonicalUrl}>
  <PageHeader
    title={post.title}
    subtitle={post.body}
    author={author}
    bgType="bordered"
    featuredImage={post.featuredImage}
  />
  <section class="my-12">
    <div class="narrow container">
      <p class="text-2xl">{post.body}</p>
    </div>
  </section>
</DefaultLayout>
